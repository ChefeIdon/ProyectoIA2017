--------------Comienzo--------------
926
880
927
972
925
881
973
971
879
834
835
833
928
882
974
1018
1019
1017
924
970
878
836
1020
1016
832
788
789
787
790
786
929
883
975
837
1021
1064
1065
1063
1066
1062
923
969
877
1015
831
791
1067
1061
785
742
743
741
744
740
739
930
884
976
838
1068
1110
1111
1109
1112
1108
1113
1107
922
968
876
1014
830
1060
784
746
1114
1106
738
696
697
699
693
700
692
931
885
977
839
793
1069
747
1115
1156
1157
1155
1158
1154
1159
1153
1160
1152
921
967
875
1013
829
1059
783
1105
737
701
1161
1151
691
650
649
652
648
653
647
654
646
655
645
978
840
1024
794
1070
748
702
1162
1202
1203
1201
1204
1200
1205
1199
1206
1198
1207
1197
920
966
874
1012
828
1058
782
1104
736
1150
690
656
1208
1196
644
605
603
606
607
608
609
610
933
887
979
841
795
1071
749
703
1163
657
1209
1248
1249
1247
1250
1246
1251
1245
1252
1244
1253
1243
1254
1242
611
1255
558
559
557
560
561
562
554
563
553
564
552
565
934
888
980
842
1026
796
750
1118
704
1164
658
1210
612
1256
1294
1295
1293
1296
1292
1297
1291
1298
1290
1299
1289
1300
1288
1301
566
1302
512
513
514
515
509
516
508
517
507
518
506
519
520
935
889
981
843
1027
797
1073
751
705
1165
659
1211
613
1257
567
1303
1340
1341
1339
1342
1338
1343
1337
1344
1336
1345
1335
1346
1334
1347
1348
521
1349
466
467
465
468
464
469
463
470
462
471
461
472
460
473
474
475
936
890
982
844
1028
798
1074
752
1120
706
660
1212
614
1258
568
1304
522
1350
1386
1387
1385
1388
1384
1389
1383
1390
1382
1391
1381
1392
1380
1393
1394
1395
476
1396
420
421
419
422
418
423
417
424
416
425
415
426
414
427
428
429
430
937
891
983
845
1029
799
1075
753
1121
707
1167
661
615
1259
569
1305
523
1351
477
1397
1432
1433
1431
1434
1430
1435
1429
1436
1428
1437
1427
1438
1426
1439
1440
1441
1442
374
375
373
376
372
377
371
378
370
379
369
380
368
381
382
383
938
892
984
846
1030
800
1076
754
1122
708
1168
662
1214
616
570
1306
524
328
329
327
330
326
331
325
332
324
333
323
334
322
335
336
939
893
985
847
1031
801
1077
755
1123
709
1169
663
1215
617
571
282
283
281
284
280
285
279
286
278
287
277
288
940
894
986
848
1032
802
1078
756
1124
710
1170
664
236
237
235
238
234
239
941
895
987
849
1443
1352
1398
1353
1216
1262
1033
1079
1125
803
1171
757
1444
1399
1308
1217
1445
1263
1400
1309
1446
1355
1401
1402
1356
1448
1310
1264
1218
1172
1126
1403
1357
1449
1311
1265
1219
1080
1034
1173
1127
1404
1358
1450
1312
1266
1220
988
942
1081
1035
989
1174
1128
1082
1359
1313
1405
1267
1451
1221
1175
896
943
1036
1129
897
990
944
1083
804
851
898
1037
711
665
758
712
618
759
852
991
945
619
666
620
572
573
713
667
525
526
760
714
478
899
853
1084
1038
1130
992
1176
946
1222
900
1268
574
527
621
479
480
668
431
432
761
854
528
575
529
481
482
622
576
433
434
435
715
669
623
384
385
386
387
808
716
1314
337
338
339
993
947
1039
901
1085
855
1131
809
1177
483
530
484
436
437
577
531
388
389
390
670
624
578
340
341
342
717
671
1223
1269
290
291
289
292
293
294
948
902
994
856
1040
810
1086
764
1132
1178
485
438
532
1360
391
625
579
1315
343
672
1224
295
949
903
995
857
1041
811
1087
765
1133
486
1406
439
533
1361
392
626
580
1316
344
345
719
1179
296
950
904
996
858
1042
812
1088
766
1134
1407
1452
1453
487
1362
1408
534
440
1271
1317
627
1363
1226
720
1272
674
997
951
1043
905
1089
859
813
1181
1454
581
1409
1318
1364
393
767
1227
721
1273
998
952
1044
906
860
1136
814
535
1455
488
582
1410
441
675
1319
629
1365
394
1182
768
1228
722
1274
346
999
953
1045
907
861
1137
815
1183
536
1456
489
1411
442
676
1320
630
1366
395
769
1229
723
1275
1000
954
1046
908
1092
862
1138
537
1457
490
584
1412
443
677
1321
631
1367
396
816
1184
770
1230
724
1276
347
1001
955
1047
909
1093
863
1139
817
1185
1458
491
585
1413
444
678
1322
632
1368
397
771
1231
725
1277
348
1002
956
1048
1094
864
1140
818
1186
539
493
446
586
540
1414
1459
399
679
633
587
1323
349
350
351
772
726
680
1232
1278
299
300
298
301
297
302
303
957
911
1003
865
1049
819
1095
773
1141
447
494
448
400
401
541
495
1369
352
353
354
634
588
542
304
305
306
727
681
635
1187
1233
254
255
253
256
252
257
251
258
250
912
866
958
820
1004
774
1050
728
1096
449
402
496
1324
355
589
543
1279
307
682
1142
636
1188
259
867
821
1005
775
1051
1097
450
1370
403
497
1325
1415
356
590
1234
544
1280
1460
308
309
729
683
1143
637
1189
260
914
960
822
1006
776
1052
730
1098
451
1371
404
498
1326
1416
357
591
1235
545
1281
1461
684
1144
638
1190
261
915
869
961
1007
777
1053
452
1372
405
499
1327
1417
358
592
1236
546
1282
1462
310
311
731
1099
685
1145
639
1191
262
263
916
870
962
1008
778
1054
732
1100
453
1373
406
500
1328
1418
359
593
1237
547
1283
1463
686
1146
1192
264
917
871
963
825
1009
1055
733
1101
1419
1464
1374
1329
1238
1465
1420
1375
1284
1466
1421
1330
1467
1376
1422
1468
1285
1239
1331
1193
1377
1147
1423
1469
1240
1194
1286
1148
1332
1102
1378
1056
1424
1010
1470
964
918
872
826
276
233
232
231
230
187
188
186
189
185
190
184
240
241
191
192
193
141
142
140
143
139
144
138
145
242
194
195
146
147
95
96
94
97
93
98
92
99
243
196
148
149
100
101
49
50
48
51
47
52
46
197
244
198
150
151
245
102
103
104
53
54
55
56
4
5
3
6
2
7
1
8
0
152
199
153
105
106
246
200
57
58
59
247
9
10
11
107
154
108
60
61
201
155
12
13
14
248
202
62
15
109
156
249
16
63
110
203
157
17
64
18
111
65
204
158
19
112
66
20
113
67
159
21
205
114
68
160
22
206
115
69
161
23
207
162
116
208
70
24
117
71
163
25
209
72
26
118
164
210
27
73
119
165
211
28
74
120
166
212
29
75
121
167
213
30
76
122
168
214
123
169
215
32
78
216
33
79
125
171
34
80
126
172
35
81
127
173
219
82
36
128
174
220
266
83
37
129
175
221
267
130
84
176
38
222
268
360
131
85
177
39
223
269
361
407
132
86
178
40
224
270
316
362
408
133
87
179
41
225
271
317
454
409
455
180
134
226
88
272
42
318
501
410
456
502
548
594
319
273
365
227
181
457
135
503
89
549
595
641
687
458
504
366
550
320
596
274
642
228
688
734
182
43
136
90
44

-----------------Fin----------------

:- dynamic writes_disabled/0.


:- multifile prolog_list_goal/1.

prolog_list_goal(pce_principal:send_implementation(A, _, _)) :-
    pce_portray:
    (    !,
	(   B=pce_principal:send_implementation(A, F, E),
	    method_from_id(A,  (C->D)),
	    clause(B, G)
	->  format('~N~n% XPCE Method ~w->~w:~n~n', [C, D]),
	    portray_clause((E->F:-G)),
	    nl
	;   format('No XPCE method implementation for id=~p~n', [A])
	)
    ).
prolog_list_goal(pce_principal:get_implementation(A, _, _, _)) :-
    pce_portray:
    (    !,
	(   B=pce_principal:get_implementation(A, G, F, E),
	    method_from_id(A, <-(C, D)),
	    clause(B, H)
	->  format('~N~n% XPCE Method ~w<-~w:~n~n', [C, D]),
	    portray_clause((E= <-(F, G):-H)),
	    nl
	;   format('No XPCE method implementation for id=~p~n', [A])
	)
    ).

:- dynamic expand_answer/2.
:- multifile expand_answer/2.


disable_writes :-
	redefine_system_predicate(write(_)),
	assert(write(_)),
	redefine_system_predicate(writeln(_)),
	assert(writeln(_)),
	redefine_system_predicate(nl),
	assert(nl),
	assert(writes_disabled).

next_primitive_action([A|B], D, E) :-
	clause(achieved(A), _),
	achieved(A), !,
	write('Action '),
	write(A),
	write(' achieved.'),
	nl,
	remove_executed_ancestors(B, C),
	next_primitive_action(C, D, E).
next_primitive_action([A|B], A, C) :-
	primitive(A),
	remove_executed_ancestors(B, C), !.
next_primitive_action([A|C], E, F) :-
	if_fails_do(clause(planify(A, _), _),
		    throw_exception((write(A), write(' is undefined. Declare it as primitive or planify it.')))), !,
	(   planify(A, B)
	;   write('Planning for '),
	    write(A),
	    write(' failed.'),
	    nl,
	    fail
	),
	(   last_element(A, B),
	    append(B, C, D)
	;   append(B, [[A]|C], D)
	),
	writeln('          -- expanded into -> '),
	nl,
	write(D),
	nl,
	nl,
	next_primitive_action(D, E, F).

desire(get([potion, A]), 'quiero apoderarme de todas las pociones!!') :-
	at([potion, A], _).
desire(get([gold, A]), 'quiero apoderarme de muchos tesoros!') :-
	has([grave, _], [gold, A]).
desire(get([gold, A]), 'quiero apoderarme de muchos tesoros!') :-
	at([gold, A], _).
desire(rest, 'quiero estar descansado') :-
	property([agent, me], life, A),
	A<100.
desire(depositarTesoro(A), 'quiero depositar todos mis tesoros!') :-
	has([agent, me], [gold, A]).
desire(ir_a_casa, 'quiero defender mi casa!').
desire(move_at_random, 'quiero estar siempre en movimiento!').

:- multifile prolog_clause_name/2.

prolog_clause_name(A, C) :-
    pce_portray:
    (   clause(B, _, A),
	user:prolog_predicate_name(B, C)
    ).

:- dynamic expand_query/4.
:- multifile expand_query/4.


longitud([], 0).
longitud([_|A], B) :-
	longitud(A, C),
	B is C+1.

:- multifile prolog_predicate_name/2.

prolog_predicate_name(pce_principal:send_implementation(A, _, _), C) :-
    pce_portray:
    (   method_from_id(A, B),
	atom_from_method(B, C)
    ).
prolog_predicate_name(pce_principal:get_implementation(A, _, _, _), C) :-
    pce_portray:
    (   method_from_id(A, B),
	atom_from_method(B, C)
    ).

try_catch(A, _) :-
	call(A), !.
try_catch(_, A) :-
	call(A),
	fail.

:- dynamic file_search_path/2.
:- multifile file_search_path/2.

file_search_path(image, library('trace/icons')).
file_search_path(library, A) :-
	library_directory(A).
file_search_path(swi, A) :-
	system:current_prolog_flag(home, A).
file_search_path(foreign, swi(B)) :-
    system:
    (   current_prolog_flag(arch, A),
	atom_concat('lib/', A, B)
    ).
file_search_path(foreign, swi(A)) :-
    system:
    (   (   current_prolog_flag(windows, true)
	->  A=bin
	;   A=lib
	)
    ).
file_search_path(path, C) :-
    system:
    (   getenv('PATH', A),
	(   current_prolog_flag(windows, true)
	->  atomic_list_concat(B, ;, A)
	;   atomic_list_concat(B, :, A)
	),
	'$member'(C, B),
	'$no-null-bytes'(C)
    ).
file_search_path(user_profile, app_preferences('.')).
file_search_path(app_preferences, app_data('.')).
file_search_path(app_data, B) :-
    '$toplevel':
    (   current_prolog_flag(windows, true),
	catch(win_folder(appdata, A), _, fail),
	atom_concat(A, '/SWI-Prolog', B),
	(   exists_directory(B)
	->  true
	;   catch(make_directory(B), _, fail)
	)
    ).
file_search_path(app_preferences, A) :-
	'$toplevel':catch(expand_file_name(~, [A]), _, fail).
file_search_path(autoload, library('.')).
file_search_path(pack, app_data(pack)).
file_search_path(pack, swi(pack)).
file_search_path(library, A) :-
	'$pack':pack_dir(_, prolog, A).
file_search_path(foreign, A) :-
	'$pack':pack_dir(_, foreign, A).
file_search_path(pce, A) :-
	link_xpce:pcehome_(A).
file_search_path(library, pce('prolog/lib')).
file_search_path(foreign, pce(B)) :-
    link_xpce:
    (   current_prolog_flag(arch, A),
	atom_concat('lib/', A, B)
    ).
file_search_path(pce_boot, 'c:/program files/swipl/xpce/prolog/boot').
file_search_path(demo, pce('prolog/demo')).
file_search_path(contrib, pce('prolog/contrib')).
file_search_path(image, pce(bitmaps)).
file_search_path(config, B) :-
    pce_config:
    (   get(@pce, application_data, A),
	get(A, path, B)
    ).

remove_executed_ancestors([[_]|A], B) :- !,
	remove_executed_ancestors(A, B).
remove_executed_ancestors(A, A).

escribirCreencias(A) :-
	tell(A),
	write("--------------Comienzo--------------"),
	nl,
	forall(at(B, C),
	       ( write(at(B, C)),
		 nl
	       )),
	nl,
	forall(atPos(B, D),
	       ( write(atPos(B, D)),
		 nl
	       )),
	nl,
	forall(has(E, F),
	       ( write(has(E, F)),
		 nl
	       )),
	nl,
	forall(entity_descr(G, H),
	       ( write(entity_descr(G, H)),
		 nl
	       )),
	nl,
	write("-----------------Fin----------------"),
	nl.

:- thread_local thread_message_hook/3.
:- dynamic thread_message_hook/3.
:- volatile thread_message_hook/3.


implies(A, B) :-
	call(A), !,
	call(B).
implies(_, _).

achieved(rest) :-
	property([agent, me], life, B),
	property([agent, me], lifeTotal, A),
	C is A+ -10,
	B>C.
achieved(get(A)) :-
	has([agent, me], A).
achieved(goto(A)) :-
	at([agent, me], A).
achieved(drop(A)) :-
	not(has([agent, me], A)).
achieved(depositarTesoro(C)) :-
	property([agent, me], home, A),
	at([home, A], B),
	at([agent, me], B),
	has([home, A], [gold, C]).
achieved(abrirEntidad(A)) :-
	at([B, A], C),
	B\=agent,
	at([agent, me], C),
	property([agent, me],
		 lastAction,
		 cast_spell(open([B, A], [potion, _]), _)).

if_fails_do(A, _) :-
	call(A), !.
if_fails_do(_, A) :-
	call(A),
	fail.

:- dynamic name/1.


start_ag_instance(B) :-
	A=pepito,
	C=..[A, B],
	agent_init(C),
	assert(ag_name(C)),
	agent_reset,
	connect,
	run,
	disconnect.

:- multifile message_property/2.


feasible(A) :-
	dynamic_state_rels(B),
	project(A, B, _).

run :-
	get_percept(A),
	ag_name(_),
	update_beliefs(A),
	display_ag,
	nl, !,
	deliberate,
	planning_and_execution(B),
	do_action(B),
	run, !.

:- dynamic intention/1.

intention(move_at_random).

:- dynamic message_hook/3.
:- multifile message_hook/3.

message_hook('$aborted', _, _) :-
    pce_host:
    (   current_prolog_flag(xpce, true),
	send(@display, reset),
	fail
    ).

:- dynamic pce_post_expansion_hook/2.
:- multifile pce_post_expansion_hook/2.


throw_exception(A) :-
	write('EXCEPTION: '),
	dont_fail(A),
	break.

si(A) :-
	start_ag_instance(A).

escribirNodos(A) :-
	tell(A),
	write("--------------Comienzo--------------"),
	nl,
	forall(node(B, _, _),
	       ( write(B),
		 nl
	       )),
	nl,
	write("-----------------Fin----------------"),
	nl.

cantNodos(C) :-
	findall(A, node(A, _, _), B),
	longitud(B, C).

:- dynamic exception/3.
:- multifile exception/3.


deliberate :-
	once(high_priority(A, B)),
	not(intention(A)),
	write('High-priority Desire: '),
	write(A),
	write(', since '),
	writeln(B),
	nl,
	retractall(intention(_)),
	retractall(plan(_)),
	assert(intention(A)),
	assert(plan([A])).
deliberate :-
	(   not(intention(_)),
	    writeln('There is no intention '),
	    nl
	;   intention(A),
	    achieved(A),
	    write('Intention '),
	    write(A),
	    writeln(' achieved.')
	;   plan([]),
	    writeln('Plan consumed.')
	;   (   plan(B),
		B\=[],
		not(feasible(B))
	    ;   not(plan(_))
	    ),
	    writeln('Current plan became infeasible.'),
	    nl
	), !,
	findall(C, desire(C, _), D),
	write('Desires: '),
	writeln(D),
	nl,
	select_intention(E, F, D),
	write('New Intention: '),
	write(E),
	write(', since '),
	writeln(F),
	nl,
	retractall(intention(_)),
	retractall(plan(_)),
	assert(intention(E)),
	assert(plan([E])).
deliberate :-
	intention(A),
	write('Current Intention: '),
	writeln(A),
	nl.
deliberate :-
	deliberate.

:- dynamic resource/3.
:- multifile resource/3.


:- dynamic plan/1.


:- dynamic pce_pre_expansion_hook/2.
:- multifile pce_pre_expansion_hook/2.


dont_fail(A) :-
	call(A).
dont_fail(_).

:- dynamic prolog_exception_hook/4.
:- multifile prolog_exception_hook/4.

prolog_exception_hook(error(A, context(D, B)), error(A, context(prolog_stack(J), B)), G, C) :-
    prolog_stack:
    (   current_prolog_flag(backtrace, true),
	(   atom(C)
	->  debug(backtrace,
		  'Got uncaught (guard = ~q) exception ~p (Ctx0=~p)',
		  [C, A, D]),
	    stack_guard(C)
	;   prolog_frame_attribute(C, predicate_indicator, E),
	    debug(backtrace,
		  'Got exception ~p (Ctx0=~p, Catcher=~p)',
		  [A, D, E]),
	    stack_guard(E)
	),
	(   current_prolog_flag(backtrace_depth, F)
	->  F>0
	;   F=20
	),
	get_prolog_backtrace(G, F, H),
	debug(backtrace, 'Stack = ~p', [H]),
	clean_stack(H, I),
	join_stacks(D, I, J)
    ).

start_ag :-
	A=miguelito,
	agent_init(A),
	assert(ag_name(A)),
	agent_reset,
	connect,
	run,
	disconnect.

:- dynamic prolog_load_file/2.
:- multifile prolog_load_file/2.


planify(get(A), B) :-
	at(A, C),
	B=[goto(C), pickup(A)].
planify(get(A), C) :-
	has([B, D], A),
	B\=agent,
	C=[abrirEntidad(D), get(A)].
planify(ir_a_casa, B) :-
	property([agent, me], home, A),
	at([home, A], C),
	B=[goto(C)].
planify(goto(A), B) :-
	buscar_plan_desplazamiento([A], B, _), !.
planify(rest, A) :-
	at([inn, _], B),
	A=[goto(B), stay].
planify(stay, [noop, stay]).
planify(move_at_random, C) :-
	findall(A, node(A, _, _), B),
	random_member(D, B),
	C=[goto(D)].
planify(drop(A), B) :-
	has([agent, me], A),
	B=[drop(A)].
planify(depositarTesoro(A), C) :-
	has([agent, me], [gold, A]),
	property([agent, me], home, B),
	at([home, B], D),
	C=[goto(D), drop([gold, A])].
planify(abrirEntidad(A), C) :-
	at([B, A], D),
	B\=agent,
	has([agent, me], [potion, E]),
	C=[goto(D), cast_spell(open([B, A], [potion, E]))].
planify(abrirEntidad(A), D) :-
	at([B, A], E),
	B\=agent,
	not(has([agent, me], [potion, C])),
	at([potion, C], _),
	D=[get([potion, C]), goto(E), cast_spell(open([B, A], [potion, C]))].

select_intention(rest, 'voy a recargar antes de encarar otro deseo', A) :-
	member(rest, A),
	property([agent, me], life, B),
	B<75.
select_intention(get(A), 'es el objeto en la tumba mas cercana de los que deseo obtener', B) :-
	findall(D,
		( member(get(A), B),
		  has([grave, C], A),
		  at([grave, C], D)
		),
		E),
	buscar_plan_desplazamiento(E, _, F),
	member(get(A), B),
	has([grave, C], A),
	at([grave, C], F).
select_intention(get(A), 'es el objeto más cercano de los que deseo obtener', B) :-
	findall(C,
		( member(get(A), B),
		  at(A, C)
		),
		D),
	buscar_plan_desplazamiento(D, _, E),
	member(get(A), B),
	at(A, E).
select_intention(depositarTesoro(A), 'quiero depositar todos mis tesoros!', B) :-
	has([agent, me], [gold, A]),
	member(depositarTesoro(A), B).
select_intention(rest, 'no tengo otra cosa más interesante que hacer', A) :-
	member(rest, A).
select_intention(ir_a_casa, 'no tengo otra que hacer, voy a defender mi casa', A) :-
	member(ir_a_casa, A).
select_intention(move_at_random, 'no tengo otra cosa más interesante que hacer', A) :-
	member(move_at_random, A).

:- dynamic high_priority/2.

high_priority(rest, 'necesito descansar') :-
	property([agent, me], life, A),
	A<50,
	once(at([inn, _], _)).

:- dynamic ag_name/1.

ag_name(miguelito).

:- dynamic prolog_event_hook/1.
:- multifile prolog_event_hook/1.


s :-
	start_ag.

planning_and_execution(B) :-
	retract(plan(A)),
	write('Following plan: '),
	writeln(A),
	nl,
	next_primitive_action(A, B, C),
	write('Next action: '),
	writeln(B),
	assert(plan(C)).

:- dynamic prolog_file_type/2.
:- multifile prolog_file_type/2.

prolog_file_type(pl, prolog).
prolog_file_type(prolog, prolog).
prolog_file_type(qlf, prolog).
prolog_file_type(qlf, qlf).
prolog_file_type(A, executable) :-
	system:current_prolog_flag(shared_object_extension, A).

:- dynamic portray/1.
:- multifile portray/1.

portray(A) :-
    pce_portray:
    (   A= @B,
	object(A), !,
	(   send(A, '_instance_of'(var))
	->  get(A, '_value', C),
	    format('@~w(= ~p)', [B, C])
	;   get(A, '_class_name', D),
	    format('@~w/~w', [B, D])
	)
    ).
portray(pce_principal:send_implementation(B, D, A)) :-
    pce_portray:
    (   object(A), !,
	method_from_id(B,  (C->_)),
	format('Send-method on ~p: ~w->~p', [A, C, D])
    ).
portray(pce_principal:get_implementation(B, D, A, E)) :-
    pce_portray:
    (   object(A), !,
	method_from_id(B, <-(C, _)),
	format('Get-method on ~p: ~w<-~p --> ~p',
	       [A, C, D, E])
    ).

:- dynamic library_directory/1.
:- multifile library_directory/1.

library_directory(B) :-
    '$parms':
    (   cached_library_directory(local, A=lib, A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(user,
				 expand_file_name('~/lib/prolog', [A]),
				 A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(system,
				 absolute_file_name(swi(library), A),
				 A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(clp,
				 absolute_file_name(swi('library/clp'), A),
				 A),
	B=A
    ).

primitive(move(_)).
primitive(pickup(_)).
primitive(drop(_)).
primitive(attack(_)).
primitive(cast_spell(_)).
primitive(noop).

:- dynamic writes_disabled/0.


:- multifile prolog_list_goal/1.

prolog_list_goal(pce_principal:send_implementation(A, _, _)) :-
    pce_portray:
    (    !,
	(   B=pce_principal:send_implementation(A, F, E),
	    method_from_id(A,  (C->D)),
	    clause(B, G)
	->  format('~N~n% XPCE Method ~w->~w:~n~n', [C, D]),
	    portray_clause((E->F:-G)),
	    nl
	;   format('No XPCE method implementation for id=~p~n', [A])
	)
    ).
prolog_list_goal(pce_principal:get_implementation(A, _, _, _)) :-
    pce_portray:
    (    !,
	(   B=pce_principal:get_implementation(A, G, F, E),
	    method_from_id(A, <-(C, D)),
	    clause(B, H)
	->  format('~N~n% XPCE Method ~w<-~w:~n~n', [C, D]),
	    portray_clause((E= <-(F, G):-H)),
	    nl
	;   format('No XPCE method implementation for id=~p~n', [A])
	)
    ).

:- dynamic expand_answer/2.
:- multifile expand_answer/2.


disable_writes :-
	redefine_system_predicate(write(_)),
	assert(write(_)),
	redefine_system_predicate(writeln(_)),
	assert(writeln(_)),
	redefine_system_predicate(nl),
	assert(nl),
	assert(writes_disabled).

next_primitive_action([A|B], D, E) :-
	clause(achieved(A), _),
	achieved(A), !,
	write('Action '),
	write(A),
	write(' achieved.'),
	nl,
	remove_executed_ancestors(B, C),
	next_primitive_action(C, D, E).
next_primitive_action([A|B], A, C) :-
	primitive(A),
	remove_executed_ancestors(B, C), !.
next_primitive_action([A|C], E, F) :-
	if_fails_do(clause(planify(A, _), _),
		    throw_exception((write(A), write(' is undefined. Declare it as primitive or planify it.')))), !,
	(   planify(A, B)
	;   write('Planning for '),
	    write(A),
	    write(' failed.'),
	    nl,
	    fail
	),
	(   last_element(A, B),
	    append(B, C, D)
	;   append(B, [[A]|C], D)
	),
	writeln('          -- expanded into -> '),
	nl,
	write(D),
	nl,
	nl,
	next_primitive_action(D, E, F).

desire(get([potion, A]), 'quiero apoderarme de todas las pociones!!') :-
	at([potion, A], _).
desire(get([gold, A]), 'quiero apoderarme de muchos tesoros!') :-
	has([grave, _], [gold, A]).
desire(get([gold, A]), 'quiero apoderarme de muchos tesoros!') :-
	at([gold, A], _).
desire(rest, 'quiero estar descansado') :-
	property([agent, me], life, A),
	A<100.
desire(depositarTesoro(A), 'quiero depositar todos mis tesoros!') :-
	has([agent, me], [gold, A]).
desire(ir_a_casa, 'quiero defender mi casa!').
desire(move_at_random, 'quiero estar siempre en movimiento!').

:- multifile prolog_clause_name/2.

prolog_clause_name(A, C) :-
    pce_portray:
    (   clause(B, _, A),
	user:prolog_predicate_name(B, C)
    ).

:- dynamic expand_query/4.
:- multifile expand_query/4.


longitud([], 0).
longitud([_|A], B) :-
	longitud(A, C),
	B is C+1.

:- multifile prolog_predicate_name/2.

prolog_predicate_name(pce_principal:send_implementation(A, _, _), C) :-
    pce_portray:
    (   method_from_id(A, B),
	atom_from_method(B, C)
    ).
prolog_predicate_name(pce_principal:get_implementation(A, _, _, _), C) :-
    pce_portray:
    (   method_from_id(A, B),
	atom_from_method(B, C)
    ).

try_catch(A, _) :-
	call(A), !.
try_catch(_, A) :-
	call(A),
	fail.

:- dynamic file_search_path/2.
:- multifile file_search_path/2.

file_search_path(image, library('trace/icons')).
file_search_path(library, A) :-
	library_directory(A).
file_search_path(swi, A) :-
	system:current_prolog_flag(home, A).
file_search_path(foreign, swi(B)) :-
    system:
    (   current_prolog_flag(arch, A),
	atom_concat('lib/', A, B)
    ).
file_search_path(foreign, swi(A)) :-
    system:
    (   (   current_prolog_flag(windows, true)
	->  A=bin
	;   A=lib
	)
    ).
file_search_path(path, C) :-
    system:
    (   getenv('PATH', A),
	(   current_prolog_flag(windows, true)
	->  atomic_list_concat(B, ;, A)
	;   atomic_list_concat(B, :, A)
	),
	'$member'(C, B),
	'$no-null-bytes'(C)
    ).
file_search_path(user_profile, app_preferences('.')).
file_search_path(app_preferences, app_data('.')).
file_search_path(app_data, B) :-
    '$toplevel':
    (   current_prolog_flag(windows, true),
	catch(win_folder(appdata, A), _, fail),
	atom_concat(A, '/SWI-Prolog', B),
	(   exists_directory(B)
	->  true
	;   catch(make_directory(B), _, fail)
	)
    ).
file_search_path(app_preferences, A) :-
	'$toplevel':catch(expand_file_name(~, [A]), _, fail).
file_search_path(autoload, library('.')).
file_search_path(pack, app_data(pack)).
file_search_path(pack, swi(pack)).
file_search_path(library, A) :-
	'$pack':pack_dir(_, prolog, A).
file_search_path(foreign, A) :-
	'$pack':pack_dir(_, foreign, A).
file_search_path(pce, A) :-
	link_xpce:pcehome_(A).
file_search_path(library, pce('prolog/lib')).
file_search_path(foreign, pce(B)) :-
    link_xpce:
    (   current_prolog_flag(arch, A),
	atom_concat('lib/', A, B)
    ).
file_search_path(pce_boot, 'c:/program files/swipl/xpce/prolog/boot').
file_search_path(demo, pce('prolog/demo')).
file_search_path(contrib, pce('prolog/contrib')).
file_search_path(image, pce(bitmaps)).
file_search_path(config, B) :-
    pce_config:
    (   get(@pce, application_data, A),
	get(A, path, B)
    ).

remove_executed_ancestors([[_]|A], B) :- !,
	remove_executed_ancestors(A, B).
remove_executed_ancestors(A, A).

escribirCreencias(A) :-
	tell(A),
	write("--------------Comienzo--------------"),
	nl,
	forall(at(B, C),
	       ( write(at(B, C)),
		 nl
	       )),
	nl,
	forall(atPos(B, D),
	       ( write(atPos(B, D)),
		 nl
	       )),
	nl,
	forall(has(E, F),
	       ( write(has(E, F)),
		 nl
	       )),
	nl,
	forall(entity_descr(G, H),
	       ( write(entity_descr(G, H)),
		 nl
	       )),
	nl,
	write("-----------------Fin----------------"),
	nl.

:- thread_local thread_message_hook/3.
:- dynamic thread_message_hook/3.
:- volatile thread_message_hook/3.


implies(A, B) :-
	call(A), !,
	call(B).
implies(_, _).

achieved(rest) :-
	property([agent, me], life, B),
	property([agent, me], lifeTotal, A),
	C is A+ -10,
	B>C.
achieved(get(A)) :-
	has([agent, me], A).
achieved(goto(A)) :-
	at([agent, me], A).
achieved(drop(A)) :-
	not(has([agent, me], A)).
achieved(depositarTesoro(C)) :-
	property([agent, me], home, A),
	at([home, A], B),
	at([agent, me], B),
	has([home, A], [gold, C]).
achieved(abrirEntidad(A)) :-
	at([B, A], C),
	B\=agent,
	at([agent, me], C),
	property([agent, me],
		 lastAction,
		 cast_spell(open([B, A], [potion, _]), _)).

if_fails_do(A, _) :-
	call(A), !.
if_fails_do(_, A) :-
	call(A),
	fail.

:- dynamic name/1.


start_ag_instance(B) :-
	A=pepito,
	C=..[A, B],
	agent_init(C),
	assert(ag_name(C)),
	agent_reset,
	connect,
	run,
	disconnect.

:- multifile message_property/2.


feasible(A) :-
	dynamic_state_rels(B),
	project(A, B, _).

run :-
	get_percept(A),
	ag_name(_),
	update_beliefs(A),
	display_ag,
	nl, !,
	deliberate,
	planning_and_execution(B),
	do_action(B),
	run, !.

:- dynamic intention/1.

intention(move_at_random).

:- dynamic message_hook/3.
:- multifile message_hook/3.

message_hook('$aborted', _, _) :-
    pce_host:
    (   current_prolog_flag(xpce, true),
	send(@display, reset),
	fail
    ).

:- dynamic pce_post_expansion_hook/2.
:- multifile pce_post_expansion_hook/2.


throw_exception(A) :-
	write('EXCEPTION: '),
	dont_fail(A),
	break.

si(A) :-
	start_ag_instance(A).

escribirNodos(A) :-
	tell(A),
	write("--------------Comienzo--------------"),
	nl,
	forall(node(B, _, _),
	       ( write(B),
		 nl
	       )),
	nl,
	write("-----------------Fin----------------"),
	nl.

cantNodos(C) :-
	findall(A, node(A, _, _), B),
	longitud(B, C).

:- dynamic exception/3.
:- multifile exception/3.


deliberate :-
	once(high_priority(A, B)),
	not(intention(A)),
	write('High-priority Desire: '),
	write(A),
	write(', since '),
	writeln(B),
	nl,
	retractall(intention(_)),
	retractall(plan(_)),
	assert(intention(A)),
	assert(plan([A])).
deliberate :-
	(   not(intention(_)),
	    writeln('There is no intention '),
	    nl
	;   intention(A),
	    achieved(A),
	    write('Intention '),
	    write(A),
	    writeln(' achieved.')
	;   plan([]),
	    writeln('Plan consumed.')
	;   (   plan(B),
		B\=[],
		not(feasible(B))
	    ;   not(plan(_))
	    ),
	    writeln('Current plan became infeasible.'),
	    nl
	), !,
	findall(C, desire(C, _), D),
	write('Desires: '),
	writeln(D),
	nl,
	select_intention(E, F, D),
	write('New Intention: '),
	write(E),
	write(', since '),
	writeln(F),
	nl,
	retractall(intention(_)),
	retractall(plan(_)),
	assert(intention(E)),
	assert(plan([E])).
deliberate :-
	intention(A),
	write('Current Intention: '),
	writeln(A),
	nl.
deliberate :-
	deliberate.

:- dynamic resource/3.
:- multifile resource/3.


:- dynamic plan/1.


:- dynamic pce_pre_expansion_hook/2.
:- multifile pce_pre_expansion_hook/2.


dont_fail(A) :-
	call(A).
dont_fail(_).

:- dynamic prolog_exception_hook/4.
:- multifile prolog_exception_hook/4.

prolog_exception_hook(error(A, context(D, B)), error(A, context(prolog_stack(J), B)), G, C) :-
    prolog_stack:
    (   current_prolog_flag(backtrace, true),
	(   atom(C)
	->  debug(backtrace,
		  'Got uncaught (guard = ~q) exception ~p (Ctx0=~p)',
		  [C, A, D]),
	    stack_guard(C)
	;   prolog_frame_attribute(C, predicate_indicator, E),
	    debug(backtrace,
		  'Got exception ~p (Ctx0=~p, Catcher=~p)',
		  [A, D, E]),
	    stack_guard(E)
	),
	(   current_prolog_flag(backtrace_depth, F)
	->  F>0
	;   F=20
	),
	get_prolog_backtrace(G, F, H),
	debug(backtrace, 'Stack = ~p', [H]),
	clean_stack(H, I),
	join_stacks(D, I, J)
    ).

start_ag :-
	A=miguelito,
	agent_init(A),
	assert(ag_name(A)),
	agent_reset,
	connect,
	run,
	disconnect.

:- dynamic prolog_load_file/2.
:- multifile prolog_load_file/2.


planify(get(A), B) :-
	at(A, C),
	B=[goto(C), pickup(A)].
planify(get(A), C) :-
	has([B, D], A),
	B\=agent,
	C=[abrirEntidad(D), get(A)].
planify(ir_a_casa, B) :-
	property([agent, me], home, A),
	at([home, A], C),
	B=[goto(C)].
planify(goto(A), B) :-
	buscar_plan_desplazamiento([A], B, _), !.
planify(rest, A) :-
	at([inn, _], B),
	A=[goto(B), stay].
planify(stay, [noop, stay]).
planify(move_at_random, C) :-
	findall(A, node(A, _, _), B),
	random_member(D, B),
	C=[goto(D)].
planify(drop(A), B) :-
	has([agent, me], A),
	B=[drop(A)].
planify(depositarTesoro(A), C) :-
	has([agent, me], [gold, A]),
	property([agent, me], home, B),
	at([home, B], D),
	C=[goto(D), drop([gold, A])].
planify(abrirEntidad(A), C) :-
	at([B, A], D),
	B\=agent,
	has([agent, me], [potion, E]),
	C=[goto(D), cast_spell(open([B, A], [potion, E]))].
planify(abrirEntidad(A), D) :-
	at([B, A], E),
	B\=agent,
	not(has([agent, me], [potion, C])),
	at([potion, C], _),
	D=[get([potion, C]), goto(E), cast_spell(open([B, A], [potion, C]))].

select_intention(rest, 'voy a recargar antes de encarar otro deseo', A) :-
	member(rest, A),
	property([agent, me], life, B),
	B<75.
select_intention(get(A), 'es el objeto en la tumba mas cercana de los que deseo obtener', B) :-
	findall(D,
		( member(get(A), B),
		  has([grave, C], A),
		  at([grave, C], D)
		),
		E),
	buscar_plan_desplazamiento(E, _, F),
	member(get(A), B),
	has([grave, C], A),
	at([grave, C], F).
select_intention(get(A), 'es el objeto más cercano de los que deseo obtener', B) :-
	findall(C,
		( member(get(A), B),
		  at(A, C)
		),
		D),
	buscar_plan_desplazamiento(D, _, E),
	member(get(A), B),
	at(A, E).
select_intention(depositarTesoro(A), 'quiero depositar todos mis tesoros!', B) :-
	has([agent, me], [gold, A]),
	member(depositarTesoro(A), B).
select_intention(rest, 'no tengo otra cosa más interesante que hacer', A) :-
	member(rest, A).
select_intention(ir_a_casa, 'no tengo otra que hacer, voy a defender mi casa', A) :-
	member(ir_a_casa, A).
select_intention(move_at_random, 'no tengo otra cosa más interesante que hacer', A) :-
	member(move_at_random, A).

:- dynamic high_priority/2.

high_priority(rest, 'necesito descansar') :-
	property([agent, me], life, A),
	A<50,
	once(at([inn, _], _)).

:- dynamic ag_name/1.

ag_name(miguelito).

:- dynamic prolog_event_hook/1.
:- multifile prolog_event_hook/1.


s :-
	start_ag.

planning_and_execution(B) :-
	retract(plan(A)),
	write('Following plan: '),
	writeln(A),
	nl,
	next_primitive_action(A, B, C),
	write('Next action: '),
	writeln(B),
	assert(plan(C)).

:- dynamic prolog_file_type/2.
:- multifile prolog_file_type/2.

prolog_file_type(pl, prolog).
prolog_file_type(prolog, prolog).
prolog_file_type(qlf, prolog).
prolog_file_type(qlf, qlf).
prolog_file_type(A, executable) :-
	system:current_prolog_flag(shared_object_extension, A).

:- dynamic portray/1.
:- multifile portray/1.

portray(A) :-
    pce_portray:
    (   A= @B,
	object(A), !,
	(   send(A, '_instance_of'(var))
	->  get(A, '_value', C),
	    format('@~w(= ~p)', [B, C])
	;   get(A, '_class_name', D),
	    format('@~w/~w', [B, D])
	)
    ).
portray(pce_principal:send_implementation(B, D, A)) :-
    pce_portray:
    (   object(A), !,
	method_from_id(B,  (C->_)),
	format('Send-method on ~p: ~w->~p', [A, C, D])
    ).
portray(pce_principal:get_implementation(B, D, A, E)) :-
    pce_portray:
    (   object(A), !,
	method_from_id(B, <-(C, _)),
	format('Get-method on ~p: ~w<-~p --> ~p',
	       [A, C, D, E])
    ).

:- dynamic library_directory/1.
:- multifile library_directory/1.

library_directory(B) :-
    '$parms':
    (   cached_library_directory(local, A=lib, A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(user,
				 expand_file_name('~/lib/prolog', [A]),
				 A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(system,
				 absolute_file_name(swi(library), A),
				 A),
	B=A
    ).
library_directory(B) :-
    '$parms':
    (   cached_library_directory(clp,
				 absolute_file_name(swi('library/clp'), A),
				 A),
	B=A
    ).

primitive(move(_)).
primitive(pickup(_)).
primitive(drop(_)).
primitive(attack(_)).
primitive(cast_spell(_)).
primitive(noop).
